/**
 * Copyright (c) 2016 Rob Wu <rob@robwu.nl> (https://robwu.nl)
 * Published under a MIT license.
 * https://github.com/Rob--W/zipinfo.js
 **/
"use strict";var ZipInfo="object"==typeof module&&module.exports||{};ZipInfo.getEntries=function(e,t){for(var n=new DataView(e.buffer,e.byteOffset,e.length),r=0,o=0,i=e.length,a=e.length-22,f=Math.max(0,a-65535);a>=f;--a)if(80===e[a]&&75===e[a+1]&&5===e[a+2]&&6===e[a+3]){i=a,o=n.getUint32(a+16,!0),r=n.getUint16(a+8,!0);break}var s=[{directory:!0,filename:"/",uncompressedSize:0,centralDirectoryStart:o}];if(t&&(o-=t),o>=e.length||o<=0)for(o=-1,r=65535;++o<e.length&&80!==e[o]&&75!==e[o+1]&&1!==e[o+2]&&2!==e[o+3];);for(i-=46;--r>=0&&o<i&&1347092738==n.getUint32(o);){var c=n.getUint16(o+8,!0),d=n.getUint32(o+24,!0),u=n.getUint16(o+28,!0),p=n.getUint16(o+30,!0),g=n.getUint16(o+32,!0),l=e.subarray(o+46,o+46+u),y=2048&c?"utf-8":"ascii";l=ZipInfo._decodeFilename(l,y),s.push({directory:l.endsWith("/"),filename:l,uncompressedSize:d}),o+=46+u+p+g}return s},ZipInfo._decodeFilename=function(e,t){return"function"==typeof TextDecoder?new TextDecoder(t).decode(e):new Buffer(e).toString(t)},ZipInfo.runGetEntriesOverHttp=function(e,t){function n(e,t){if(e)return"bytes="+e+"-"+(t-1)+"/"+t}var r=e({onHeadersReceived:function(o){var i=parseInt(o("Content-Length"),10)||0;if(!(i<1e5||"bytes"!==o("Accept-Ranges"))){r.abort();var a=i-65535-23;e({rangeHeader:n(a,i),onCompleted:function(r){a&&r.byteLength===i&&(a=0);var o=ZipInfo.getEntries(r,a);o[0].centralDirectoryStart>=a?t(o):(a=o[0].centralDirectoryStart,e({rangeHeader:n(a,i),onCompleted:function(e){t(ZipInfo.getEntries(e,a))}}))}})}},onCompleted:function(e){t(ZipInfo.getEntries(e))}})},ZipInfo.getRemoteEntries=function(e,t){function n(t){var n=t.onCompleted,r=GM_xmlhttpRequest({responseType:"arraybuffer",headers:t.rangeHeader?{Range:t.rangeHeader}:{},onreadystatechange:function(e){if(2===e.readyState&&t.onHeadersReceived){var r="\r\n"+e.responseHeaders;t.onHeadersReceived(function(e){e="\r\n"+e.toLowerCase()+": ";var t=r.toLowerCase().indexOf(e);return t>=0&&r.slice(t+e.length).split("\r\n")[0]})}else 4===e.readyState&&n(new Uint8Array(e.response||0))},url:e});return{abort:function(){n=function(){},r.abort()}}}ZipInfo.runGetEntriesOverHttp(n,t)};